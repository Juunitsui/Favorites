<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>유사 마피아: 시장 모드 시뮬레이터 — 확장판</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111824; --muted:#7787a2; --accent:#6ee7b7; --accent2:#60a5fa; --danger:#f87171; --warn:#fbbf24; --ok:#34d399;
      --dead:#2a3444; --alive:#141c29; --mafia:#ef4444; --citizen:#38bdf8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#e5ecf5;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Apple Color Emoji,Segoe UI Emoji}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0f14 60%,#0b0f1400);z-index:30}
    h1{margin:12px 0 4px;font-size:22px;letter-spacing:0.2px}
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button,select,input[type=checkbox]+label{font-weight:600}
    button{background:#1e293b;border:1px solid #263445;color:#e8eef7;padding:8px 12px;border-radius:10px;cursor:pointer}
    button:hover{border-color:#3f4f66}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid #22304a;color:#b9c7dd;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:12px}
    .card{background:var(--alive);border:1px solid #233047;border-radius:12px;padding:10px;position:relative}
    .card.dead{background:var(--dead);opacity:.78}
    .card .name{font-size:20px;font-weight:800;letter-spacing:1px}
    .roleTag{position:absolute;top:8px;right:8px;padding:2px 8px;border-radius:10px;font-size:11px;border:1px solid #334155;color:#cbd5e1;background:#0b1220}
    .roleTag.mafia{border-color:#7f1d1d;color:#fecaca}
    .roleTag.citizen{border-color:#0e7490;color:#a5f3fc}
    .counts{margin:6px 0 8px;font-size:12px;color:#9fb0c9;display:flex;justify-content:space-between}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .actions .exile{background:#172554;border:1px solid #1e3a8a}
    .actions .exile:hover{border-color:#60a5fa}
    .actions .exile[disabled]{opacity:.5}
    .pill{display:inline-block;background:#0f1b2e;color:#a9bbd6;border:1px solid #2a3a54;padding:4px 8px;border-radius:999px;font-size:12px}

    .panels{display:grid;grid-template-columns:1.25fr 1fr;gap:14px;margin-top:16px}
    @media (max-width:980px){.panels{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid #233047;border-radius:14px;padding:12px}
    .panel h2{margin:4px 0 10px;font-size:16px;color:#cfe3ff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #213048;padding:8px 6px;text-align:left;font-size:14px}
    th{color:#bdd0ea}
    .log{max-height:320px;overflow:auto;display:flex;flex-direction:column-reverse}
    .logItem{padding:8px 10px;border-bottom:1px dashed #263850;font-size:14px;color:#c8d7ee}
    .good{color:var(--ok)}.bad{color:var(--danger)}.warn{color:var(--warn)}
    .statRow{display:flex;gap:8px;flex-wrap:wrap}
    .statRow .stat{background:#0d1626;border:1px solid #24364e;border-radius:10px;padding:6px 10px}
    .rec{background:#11260f;border:1px solid #1f4020}
    .rec b{color:#86efac}
    .sep{height:1px;background:#22334a;margin:10px -12px}
    .cfg{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .cfg label{font-size:12px;color:#bfd0e8;display:flex;gap:6px;align-items:center;background:#0f1626;border:1px solid #24364e;border-radius:999px;padding:4px 8px}
    input[type=number],input[type=text]{background:#10192a;border:1px solid #233148;color:#e8eef7;border-radius:8px;padding:6px 8px;min-width:70px}
    input[type=range]{accent-color:#60a5fa}
    .ability{background:#122016;border:1px solid #1f3726}
    .eventNow{background:#1b1324;border:1px solid #3a274f}
    .sus{font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>유사 마피아: 시장(플레이어) 모드 — 확장판</h1>
      <div class="cfg">
        <label>마피아 수 <input id="cfgMafia" type="number" min="3" max="10" value="6"></label>
        <label>시민 정확도 <input id="cfgAcc" type="range" min="50" max="90" value="70"> <span id="accLabel">70%</span></label>
        <label>조사 정확도 <input id="cfgInspectAcc" type="range" min="60" max="95" value="80"> <span id="inspectLabel">80%</span></label>
        <label>조사권 <input id="cfgInspect" type="number" min="0" max="10" value="2"></label>
        <label>보호권 <input id="cfgProtect" type="number" min="0" max="10" value="1"></label>
        <label>하루 이벤트 <input id="cfgEvents" type="checkbox" checked></label>
        <label>시드 <input id="cfgSeed" type="text" placeholder="비워두면 임의"></label>
        <button id="newGame">새 게임 시작</button>
        <button id="autoRun" title="추천 추방을 자동으로 반복">자동 진행</button>
        <button id="quickSim">빠른 시뮬(100회)</button>
        <label class="badge"><input type="checkbox" id="reveal" /> <span>정답 보기(역할 표시)</span></label>
        <span class="badge">낮 <b id="dayNum">1</b></span>
        <span class="badge">단계: <b id="phaseLabel">낮-추방 대기</b></span>
      </div>
      <div id="topStats" class="statRow" style="margin-top:8px"></div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid" id="village"></div>

    <div class="panels">
      <section class="panel">
        <h2>시민들의 의견(참고용 지목) & 추천 지수</h2>
        <div class="statRow" id="recBox"></div>
        <div class="sep"></div>
        <table id="tallyTable">
          <thead>
            <tr>
              <th>지목 대상</th>
              <th>표 수</th>
              <th>비율</th>
              <th>추천 지수</th>
              <th>메모</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="sep"></div>
        <details>
          <summary>누가 누구를 지목했는지</summary>
          <table id="detailsTable">
            <thead><tr><th>지목자</th><th>대상</th></tr></thead>
            <tbody></tbody>
          </table>
        </details>
      </section>
      
      <section class="panel">
        <h2>시장 능력 & 이벤트</h2>
        <div class="statRow">
          <div class="stat ability">조사권 <b id="inspectLeft">0</b> / 정확도 <b id="inspectAccNow">80%</b> · <button id="inspectMode">조사 모드</button></div>
          <div class="stat ability">보호권 <b id="protectLeft">0</b> · <button id="protectMode">보호 모드</button></div>
          <div class="stat">추천 추방 <button id="autoPick">실행</button></div>
        </div>
        <div class="sep"></div>
        <div id="eventBox" class="statRow"></div>
        <div class="sep"></div>
        <h2>이벤트 로그</h2>
        <div id="log" class="log"></div>
      </section>
    </div>
  </div>

<script>
(function(){
  // ---------- RNG (seedable) ----------
  function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;}}
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}

  const LETTERS = Array.from({length:26}, (_,i)=>String.fromCharCode(65+i)); // A..Z

  const els = {
    village: document.getElementById('village'),
    dayNum: document.getElementById('dayNum'),
    phase: document.getElementById('phaseLabel'),
    log: document.getElementById('log'),
    tallyBody: document.querySelector('#tallyTable tbody'),
    detailsBody: document.querySelector('#detailsTable tbody'),
    recBox: document.getElementById('recBox'),
    reveal: document.getElementById('reveal'),
    newGame: document.getElementById('newGame'),
    autoPick: document.getElementById('autoPick'),
    topStats: document.getElementById('topStats'),
    eventBox: document.getElementById('eventBox'),
    autoRun: document.getElementById('autoRun'),
    quickSim: document.getElementById('quickSim'),
    cfgMafia: document.getElementById('cfgMafia'),
    cfgAcc: document.getElementById('cfgAcc'),
    cfgEvents: document.getElementById('cfgEvents'),
    cfgSeed: document.getElementById('cfgSeed'),
    cfgInspect: document.getElementById('cfgInspect'),
    cfgProtect: document.getElementById('cfgProtect'),
    cfgInspectAcc: document.getElementById('cfgInspectAcc'),
    accLabel: document.getElementById('accLabel'),
    inspectLabel: document.getElementById('inspectLabel'),
    inspectLeft: document.getElementById('inspectLeft'),
    protectLeft: document.getElementById('protectLeft'),
    inspectMode: document.getElementById('inspectMode'),
    protectMode: document.getElementById('protectMode'),
    inspectAccNow: document.getElementById('inspectAccNow'),
  };

  let state = {};

  function randPick(arr){ return arr.length? arr[Math.floor(state.rng()*arr.length)] : null; }

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function initGame(){
    // build RNG
    let seedStr = els.cfgSeed.value.trim();
    if(!seedStr){ seedStr = String(Date.now()); }
    const seed = xmur3(seedStr)();
    state.rng = mulberry32(seed);

    const mafiaCount = clamp(parseInt(els.cfgMafia.value||'6',10),3,10);
    const baseAcc = clamp(parseInt(els.cfgAcc.value||'70',10)/100,0.5,0.9);
    const inspectCharges = clamp(parseInt(els.cfgInspect.value||'2',10),0,10);
    const protectCharges = clamp(parseInt(els.cfgProtect.value||'1',10),0,10);
    const inspectAcc = clamp(parseInt(els.cfgInspectAcc.value||'80',10)/100,0.6,0.95);

    const people = LETTERS.map(ch=>({id: ch, role: 'citizen', alive: true, hint:null}));
    // choose mafia
    const pool = [...LETTERS];
    for(let i=0;i<mafiaCount;i++){
      const pick = Math.floor(state.rng()*pool.length);
      const id = pool.splice(pick,1)[0];
      const p = people.find(x=>x.id===id);
      p.role = 'mafia';
    }

    state = {
      rng: state.rng,
      baseAcc,
      inspectAcc,
      day: 1,
      people,
      phase: 'day',
      gameOver: false,
      votes: null,
      log: [],
      mods: {voteAccDelta:0, nightKillDelta:0, note: null},
      eventsOn: els.cfgEvents.checked,
      inspectLeft: inspectCharges,
      protectLeft: protectCharges,
      inspectMode: false,
      protectMode: false,
      protectTarget: null,
      history: [], // for stats
    };
    log(`게임 시작 — 마을 인원 ${aliveCount()}명, 마피아 ${aliveMafia()}명`);
    if(state.eventsOn){ newDayEvent(); }
    simulateVotes();
    renderAll();
  }

  // --- helpers
  function alive(){ return state.people.filter(p=>p.alive); }
  function aliveMafia(){ return state.people.filter(p=>p.alive && p.role==='mafia').length; }
  function aliveCitizens(){ return state.people.filter(p=>p.alive && p.role==='citizen').length; }
  function aliveCount(){ return alive().length; }

  // --- events
  const EVENT_POOL = [
    ()=>({name:'소문 확산', desc:'시민 정확도 +10% (이번 낮)', voteAccDelta:+0.10, nightKillDelta:0}),
    ()=>({name:'비가 와서 정보 혼선', desc:'시민 정확도 -15% (이번 낮)', voteAccDelta:-0.15, nightKillDelta:0}),
    ()=>({name:'통금 강화', desc:'밤 처형 수 -1', voteAccDelta:0, nightKillDelta:-1}),
    ()=>({name:'마피아 내분', desc:'밤 처형 수 -1 (한 명 빠짐)', voteAccDelta:0, nightKillDelta:-1}),
    ()=>({name:'유언 단서', desc:'무작위 사망자의 진짜 역할 공개', voteAccDelta:0, nightKillDelta:0, revealDead:true}),
  ];

  function newDayEvent(){
    const ev = randPick(EVENT_POOL)();
    state.mods.voteAccDelta = ev.voteAccDelta||0;
    state.mods.nightKillDelta = ev.nightKillDelta||0;
    state.mods.note = `${ev.name} — ${ev.desc}`;
    if(ev.revealDead){
      const dead = state.people.filter(p=>!p.alive);
      const pick = randPick(dead);
      if(pick){
        log(`사망자 단서: ${pick.id} 는 실제로 <b>${pick.role==='mafia'?'마피아':'시민'}</b>였음`);
      }
    }
    renderEvent();
  }

  function renderEvent(){
    const box = els.eventBox;
    if(state.mods.note){
      box.innerHTML = `<div class="stat eventNow">오늘의 이벤트: <b>${state.mods.note}</b></div>`;
    } else { box.innerHTML = ''; }
  }

  // --- votes
  function simulateVotes(){
    const voters = alive();
    const mafia = voters.filter(v=>v.role==='mafia');
    const citizens = voters.filter(v=>v.role==='citizen');

    const tally = new Map();
    const details = [];

    const effAcc = clamp(state.baseAcc + (state.mods.voteAccDelta||0), 0.05, 0.95);

    voters.forEach(voter=>{
      let target = null;
      const othersAlive = voters.filter(p=>p.id!==voter.id);
      const aliveM = othersAlive.filter(p=>p.role==='mafia');
      const aliveC = othersAlive.filter(p=>p.role==='citizen');

      if(voter.role==='mafia'){
        if(aliveC.length>0) target = randPick(aliveC); else target = randPick(othersAlive);
      } else {
        if(aliveM.length>0 && state.rng()<effAcc){ target = randPick(aliveM); }
        else { const candidates = aliveC.length>0 ? aliveC : othersAlive; target = randPick(candidates); }
      }
      if(!target) return;
      details.push({voter: voter.id, target: target.id});
      tally.set(target.id, (tally.get(target.id)||0)+1);
    });

    state.votes = {tally, details, effAcc};
    state.phase = 'day';
  }

  // --- suspicion scoring & recommendation
  function suspicionScore(id){
    const total = aliveCount();
    const votes = state.votes?.tally.get(id)||0;
    let score = 0;
    // votes weight
    score += 0.7 * (votes/Math.max(1,total));
    // investigation hints
    const p = state.people.find(x=>x.id===id);
    if(p.hint){
      if(p.hint.seen==='mafia') score += 0.25 * p.hint.conf;
      if(p.hint.seen==='citizen') score -= 0.20 * p.hint.conf;
    }
    // slight survival pressure as days pass
    score += 0.03 * Math.max(0, state.day-1);
    return score;
  }

  function bestRecommendation(){
    const rows = alive().map(p=>({id:p.id, s:suspicionScore(p.id)})).sort((a,b)=>b.s-a.s);
    return rows[0];
  }

  // --- exile & night
  function exile(id){
    if(state.gameOver || state.phase!=='day') return;
    const target = state.people.find(p=>p.id===id);
    if(!target || !target.alive) return;

    target.alive = false;
    const correct = (target.role==='mafia');
    log(`낮 ${state.day}: ${id} 추방 — ${correct?'<span class="good">마피아 적중</span>':'<span class="bad">시민 오판</span>'}`);
    state.history.push({day:state.day, type:'exile', id, correct});

    if(aliveMafia()===0){ win(); return; }
    if(aliveCitizens()===0){ lose(); return; }

    // 밤
    nightPhase();
  }

  function nightPhase(){
    state.phase = 'night';
    const baseK = aliveMafia();
    const k = Math.max(0, baseK + (state.mods.nightKillDelta||0));
    const candidates = state.people.filter(p=>p.alive && p.role==='citizen');
    const victims = [];
    let pool = [...candidates];

    // if protectTarget is set, exclude for this night
    if(state.protectTarget){
      pool = pool.filter(p=>p.id!==state.protectTarget);
    }

    for(let i=0;i<k;i++){
      if(pool.length===0) break;
      const pickIdx = Math.floor(state.rng()*pool.length);
      const v = pool.splice(pickIdx,1)[0];
      victims.push(v);
    }
    victims.forEach(v=>v.alive=false);
    state.history.push({day:state.day, type:'night', victims: victims.map(v=>v.id)});

    if(victims.length>0){ log(`밤 ${state.day}: 마피아 습격 — ${victims.map(v=>v.id).join(', ')} 사망${state.protectTarget?` (보호: ${state.protectTarget})`:''}`); }
    else { log(`밤 ${state.day}: 마피아 습격 시도 — 대상 없음${state.protectTarget?` (보호: ${state.protectTarget})`:''}`); }

    state.protectTarget = null; // reset

    if(aliveCitizens()===0){ lose(); return; }

    // 다음 낮
    state.day += 1;
    state.mods = {voteAccDelta:0, nightKillDelta:0, note:null};
    if(state.eventsOn){ newDayEvent(); }
    simulateVotes();
    renderAll();
  }

  // --- abilities
  function enterInspectMode(){ if(state.inspectLeft>0 && !state.gameOver){ state.inspectMode = true; state.protectMode = false; info(`조사할 대상을 선택… (정확도 ${Math.round(state.inspectAcc*100)}%)`);} }
  function enterProtectMode(){ if(state.protectLeft>0 && !state.gameOver){ state.protectMode = true; state.inspectMode = false; info('오늘 밤 보호할 대상을 선택…'); } }

  function useInspect(id){
    if(state.inspectLeft<=0) return;
    const p = state.people.find(x=>x.id===id);
    if(!p || !p.alive) return;
    state.inspectLeft--;
    const truth = p.role; // true role
    const conf = state.inspectAcc;
    let seen = truth;
    if(state.rng()>(conf)){ // fail -> flip result
      seen = (truth==='mafia')? 'citizen':'mafia';
    }
    p.hint = {seen, conf};
    log(`조사 결과: <b>${id}</b> 는 <b>${seen==='mafia'?'마피아':'시민'}</b>로 보임 (신뢰도 ${Math.round(conf*100)}%)`);
    state.inspectMode = false;
    renderAll();
  }

  function useProtect(id){
    if(state.protectLeft<=0) return;
    const p = state.people.find(x=>x.id===id);
    if(!p || !p.alive) return;
    state.protectLeft--;
    state.protectMode = false;
    state.protectTarget = id;
    log(`보호 지시: 오늘 밤 <b>${id}</b> 보호 예정`);
    renderAll();
  }

  // --- end states
  function win(){
    state.gameOver = true;
    state.phase = 'end';
    log(`<b class="good">승리</b> — 모든 마피아 추방 완료`);
    renderAll();
  }
  function lose(){
    state.gameOver = true;
    state.phase = 'end';
    log(`<b class="bad">패배</b> — 선량한 시민 전원 사망`);
    renderAll();
  }

  function log(html){ state.log.push({html, t: Date.now()}); renderLog(); }
  function info(txt){ log(`<span class="warn">${txt}</span>`); }

  function renderLog(){ els.log.innerHTML = state.log.slice().reverse().map(item=>`<div class="logItem">${item.html}</div>`).join(''); }

  function renderTopStats(){
    const items = [];
    items.push(`<div class="stat">남은 인원 <b>${aliveCount()}</b> / 26</div>`);
    items.push(`<div class="stat">남은 시민 <b>${aliveCitizens()}</b></div>`);
    items.push(`<div class="stat">남은 마피아 <b>${els.reveal.checked?aliveMafia():'?'}</b></div>`);
    items.push(`<div class="stat">단계 <b>${state.phase==='day'?'낮':'밤'}</b></div>`);
    if(state.votes){ items.push(`<div class="stat">시민 정확도(유효) <b>${Math.round(state.votes.effAcc*100)}%</b></div>`); }
    if(state.gameOver){ items.push(`<div class="stat rec"><b>${state.log[state.log.length-1]?.html.includes('승리')?'승리':'패배'}</b></div>`); }
    els.topStats.innerHTML = items.join('');

    els.inspectLeft.textContent = state.inspectLeft;
    els.protectLeft.textContent = state.protectLeft;
    els.inspectAccNow.textContent = `${Math.round(state.inspectAcc*100)}%`;
  }

  function renderVillage(){
    els.village.innerHTML = '';
    const frag = document.createDocumentFragment();
    // alive first
    state.people.filter(p=>p.alive).sort((a,b)=>a.id.localeCompare(b.id)).forEach(p=>frag.appendChild(cardEl(p)));
    // then dead
    state.people.filter(p=>!p.alive).forEach(p=>frag.appendChild(cardEl(p)));
    els.village.appendChild(frag);
  }

  function cardEl(p){
    const div = document.createElement('div');
    div.className = 'card'+(p.alive?'':' dead');
    const sus = suspicionScore(p.id);
    div.innerHTML = `
      <div class="name">${p.id}</div>
      <div class="counts">
        <span class="pill">${voteCountFor(p.id)} 표</span>
        <span class="pill sus">추천 ${sus.toFixed(2)}</span>
        <span class="pill">상태: ${p.alive? '생존':'사망'}</span>
      </div>
      <div class="actions"></div>
    `;
    const actions = div.querySelector('.actions');

    if(els.reveal.checked){
      const tag = document.createElement('div');
      tag.className = 'roleTag '+(p.role==='mafia'?'mafia':'citizen');
      tag.textContent = p.role==='ma피아' ? '마피아' : '시민';
      // fix typo programmatically
      tag.textContent = p.role==='mafia' ? '마피아' : '시민';
      div.appendChild(tag);
    }

    if(p.hint){
      const tag = document.createElement('div');
      tag.className = 'roleTag';
      tag.style.top = '34px';
      tag.textContent = `조사: ${p.hint.seen==='mafia'?'마피아':'시민'}(~${Math.round(p.hint.conf*100)}%)`;
      div.appendChild(tag);
    }

    if(p.alive && !state.gameOver && state.phase==='day'){
      const btn = document.createElement('button');
      btn.className = 'exile';
      btn.textContent = '추방';
      btn.onclick = ()=>{ exile(p.id); renderAll(); };
      actions.appendChild(btn);

      if(state.inspectMode && state.inspectLeft>0){
        const b = document.createElement('button');
        b.textContent = '조사';
        b.onclick = ()=> useInspect(p.id);
        actions.appendChild(b);
      }
      if(state.protectMode && state.protectLeft>0){
        const b2 = document.createElement('button');
        b2.textContent = '보호';
        b2.onclick = ()=> useProtect(p.id);
        actions.appendChild(b2);
      }
    }

    return div;
  }

  function voteCountFor(id){ if(!state.votes) return 0; return state.votes.tally.get(id)||0; }

  function renderVotes(){
    const tbody = els.tallyBody; tbody.innerHTML = '';
    if(!state.votes){ tbody.innerHTML = '<tr><td colspan="5">의견 없음</td></tr>'; return; }
    const total = aliveCount();
    const rows = [...state.votes.tally.entries()].sort((a,b)=>b[1]-a[1]);
    if(rows.length===0){ tbody.innerHTML = '<tr><td colspan="5">의견 없음</td></tr>'; return; }

    tbody.innerHTML = rows.map(([id,c])=>{
      const p = state.people.find(x=>x.id===id);
      const perc = ((c/Math.max(1,total))*100).toFixed(1)+'%';
      const memo = p.alive? '생존':'사망';
      const sus = suspicionScore(id).toFixed(2);
      return `<tr>
        <td><b>${id}</b> ${(els.reveal.checked? (p.role==='mafia'?'<span class="bad">[마피아]</span>':'<span class="good">[시민]</span>'):'')}</td>
        <td>${c}</td>
        <td>${perc}</td>
        <td><b>${sus}</b></td>
        <td>${memo}${p.hint?` · 조사:${p.hint.seen==='mafia'?'의심':'완화'}`:''}</td>
      </tr>`;
    }).join('');

    // details
    const dBody = els.detailsBody; dBody.innerHTML = '';
    const arr = state.votes.details.slice().sort((a,b)=>a.voter.localeCompare(b.voter));
    dBody.innerHTML = arr.map(x=>`<tr><td>${x.voter}</td><td>${x.target}</td></tr>`).join('');

    // recommendation box
    const top = bestRecommendation();
    if(top){ els.recBox.innerHTML = `<div class="stat rec">추천 추방 후보: <b>${top.id}</b> · 지수 ${top.s.toFixed(2)}</div>`; }
    else { els.recBox.innerHTML = ''; }
  }

  function renderAll(){
    els.dayNum.textContent = state.day;
    els.phase.textContent = state.gameOver? '게임 종료' : (state.phase==='day'?'낮-추방 대기':'밤-처리 중');
    renderVillage();
    renderVotes();
    renderTopStats();
    renderEvent();
  }

  // -- Auto controls
  function autoPick(){ const rec = bestRecommendation(); if(rec){ exile(rec.id); renderAll(); } }
  function autoRun(){
    let guard = 500; // prevent infinite
    while(!state.gameOver && guard-->0){ autoPick(); }
  }

  function quickSim(n=100){
    const snap = {
      mafia: parseInt(els.cfgMafia.value||'6',10),
      acc: parseInt(els.cfgAcc.value||'70',10),
      inspect: parseInt(els.cfgInspect.value||'2',10),
      protect: parseInt(els.cfgProtect.value||'1',10),
      inspectAcc: parseInt(els.cfgInspectAcc.value||'80',10),
      eventsOn: els.cfgEvents.checked,
    };

    let wins=0;
    for(let i=0;i<n;i++){
      // light sim with same settings but without heavy DOM/logging
      let rng = mulberry32(xmur3(String(i+Date.now()))());
      const people = LETTERS.map(ch=>({id: ch, role: 'citizen', alive: true, hint:null}));
      const pool = [...LETTERS];
      for(let m=0;m<snap.mafia;m++){ const pick=Math.floor(rng()*pool.length); const id=pool.splice(pick,1)[0]; people.find(p=>p.id===id).role='mafia'; }
      let day=1; let gameOver=false;
      let mods={voteAccDelta:0, nightKillDelta:0};
      const baseAcc = clamp(snap.acc/100,0.5,0.9);
      function aliveSim(){ return people.filter(p=>p.alive); }
      function aliveM(){ return people.filter(p=>p.alive && p.role==='mafia').length; }
      function aliveC(){ return people.filter(p=>p.alive && p.role==='citizen').length; }
      function votes(){
        const voters = aliveSim();
        const eff = clamp(baseAcc + (mods.voteAccDelta||0), 0.05, 0.95);
        const tally = new Map();
        voters.forEach(v=>{
          const others = voters.filter(x=>x.id!==v.id);
          const m = others.filter(x=>x.role==='mafia');
          const c = others.filter(x=>x.role==='citizen');
          let t=null;
          if(v.role==='mafia'){ t = c.length? c[Math.floor(rng()*c.length)] : others[Math.floor(rng()*others.length)]; }
          else { if(m.length && rng()<eff) t = m[Math.floor(rng()*m.length)]; else t = (c.length? c[Math.floor(rng()*c.length)] : others[Math.floor(rng()*others.length)]); }
          tally.set(t.id, (tally.get(t.id)||0)+1);
        });
        return tally;
      }
      function suspicion(id, tally){ const total = aliveSim().length; const v=tally.get(id)||0; return 0.7*(v/Math.max(1,total)) + 0.03*Math.max(0,day-1); }
      function exileSim(id){ const p=people.find(x=>x.id===id); p.alive=false; }
      function night(){ const k=Math.max(0,aliveM()+(mods.nightKillDelta||0)); let pool=people.filter(p=>p.alive && p.role==='citizen'); for(let j=0;j<k;j++){ if(!pool.length) break; const idx=Math.floor(rng()*pool.length); const v=pool.splice(idx,1)[0]; v.alive=false; } }
      while(!gameOver){
        if(snap.eventsOn){ mods={voteAccDelta:0, nightKillDelta:0}; /* light random effects */ if(rng()<0.25) mods.voteAccDelta += 0.1; if(rng()<0.15) mods.voteAccDelta -= 0.15; if(rng()<0.2) mods.nightKillDelta -= 1; }
        const tally=votes();
        const cand = aliveSim().map(p=>({id:p.id,s: suspicion(p.id,tally)})).sort((a,b)=>b.s-a.s)[0];
        exileSim(cand.id);
        if(aliveM()===0){ wins++; break; }
        if(aliveC()===0){ break; }
        night();
        if(aliveC()===0){ break; }
        day++;
        if(day>200){ break; }
      }
    }
    log(`빠른 시뮬(100회) 결과 — 승리 ${wins} / ${n} (승률 ${(wins/n*100).toFixed(1)}%)`);
  }

  // UI handlers
  els.newGame.addEventListener('click', initGame);
  els.reveal.addEventListener('change', renderAll);
  els.autoPick.addEventListener('click', ()=>{ autoPick(); });
  els.accLabel.textContent = els.cfgAcc.value+"%";
  els.inspectLabel.textContent = els.cfgInspectAcc.value+"%";
  els.cfgAcc.addEventListener('input', ()=> els.accLabel.textContent = els.cfgAcc.value+"%" );
  els.cfgInspectAcc.addEventListener('input', ()=> els.inspectLabel.textContent = els.cfgInspectAcc.value+"%" );
  els.inspectMode.addEventListener('click', enterInspectMode);
  els.protectMode.addEventListener('click', enterProtectMode);
  els.autoRun.addEventListener('click', ()=> autoRun());
  els.quickSim.addEventListener('click', ()=> quickSim(100));

  // global click wiring for card actions is in cardEl

  function renderVotesAndVillage(){ renderVillage(); renderVotes(); }

  // start once
  initGame();
})();
</script>
</body>
</html>
